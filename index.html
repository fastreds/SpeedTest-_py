<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Velocidad Internet Avanzado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <!-- Para manejo de fechas -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9fafb;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    h1 {
      text-align: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      max-width: 900px;
    }
    body.dark-mode #controls {
      background: #2c2c2c;
    }
    select, input, button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: border 0.3s;
    }
    body.dark-mode select, body.dark-mode input, body.dark-mode button {
      background: #3a3a3a;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    button:hover {
      background: #e0e0e0;
      cursor: pointer;
    }
    body.dark-mode button:hover {
      background: #4a4a4a;
    }
    #charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    canvas {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    body.dark-mode canvas {
      background: #2c2c2c;
    }
    #summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    body.dark-mode .stat-card {
      background: #2c2c2c;
    }
    .stat-card h3 {
      margin: 0 0 10px;
    }
    #data-table {
      margin-top: 40px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    body.dark-mode table {
      background: #2c2c2c;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    body.dark-mode th, body.dark-mode td {
      border-bottom: 1px solid #444;
    }
    th {
      background: #f0f0f0;
    }
    body.dark-mode th {
      background: #3a3a3a;
    }
    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 12px;
      border: none;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    body.dark-mode #theme-toggle {
      background: #2c2c2c;
      color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>📊 Dashboard Velocidad Internet Avanzado</h1>
  <p style="text-align:center">Datos cargados dinámicamente desde Google Sheets. Incluye estadísticas, tabla de datos y modo oscuro.</p>

  <button id="theme-toggle" onclick="toggleTheme()">🌙 Modo Oscuro</button>

  <div id="controls">
    <label>
      Dispositivos:
      <select id="deviceFilter" multiple></select> <!-- Ahora multi-select -->
    </label>
    <label>
      Desde:
      <input type="datetime-local" id="sinceFilter">
    </label>
    <label>
      Hasta:
      <input type="datetime-local" id="untilFilter">
    </label>
    <label>
      Registros:
      <select id="limitFilter">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="all">Todos</option> <!-- Nueva opción -->
      </select>
    </label>
    <label>
      Auto-actualizar:
      <select id="autoRefresh">
        <option value="0" selected>Desactivado</option>
        <option value="30000">Cada 30s</option>
        <option value="60000">Cada 1min</option>
      </select>
    </label>
    <button onclick="loadAndRender()">🔄 Actualizar</button>
    <button onclick="exportToCSV()">📥 Exportar CSV</button> <!-- Nueva función -->
  </div>

  <!-- Resumen Estadístico -->
  <div id="summary"></div>

  <!-- Gráficas -->
  <div id="charts">
    <canvas id="downloadChart"></canvas>
    <canvas id="uploadChart"></canvas>
    <canvas id="pingChart"></canvas>
    <canvas id="avgChart"></canvas> <!-- Nueva gráfica de promedios por dispositivo -->
  </div>

  <!-- Tabla de Datos -->
  <div id="data-table">
    <h2>Tabla de Registros</h2>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Dispositivo</th>
          <th>Download (Mbps)</th>
          <th>Upload (Mbps)</th>
          <th>Ping (ms)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxfxPDgtvjpuAADsT1zdYZFsr5LH0OwQHp9jkkXdMT2_O2-finRgDOpPWN0aaZewbf7kQ/exec";

    let charts = {};
    let currentData = [];
    let refreshInterval = null;

    async function fetchData(limit = 20, devices = [], since = "", until = "") {
      let url = `${SHEET_URL}?limit=${limit === 'all' ? '' : limit}`;
      if (devices.length > 0 && !devices.includes('all')) url += `&device=${devices.map(encodeURIComponent).join(',')}`;
      if (since) url += `&since=${encodeURIComponent(since)}`;
      if (until) url += `&until=${encodeURIComponent(until)}`;

      const res = await fetch(url);
      return res.json();
    }

    function buildLineChart(ctx, label, data, borderColor, backgroundColor) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.timestamp),
          datasets: [{
            label: label,
            data: data.map(d => d.value),
            borderColor,
            backgroundColor,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour' },
              ticks: { maxRotation: 45, minRotation: 45 }
            },
            y: { beginAtZero: true }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${context.parsed.y} (${context.raw.device || ''})`
              }
            }
          }
        }
      });
    }

    function buildBarChart(ctx, labels, datasets) {
      return new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    function calculateStats(data) {
      const stats = {
        download: { min: Infinity, max: -Infinity, avg: 0 },
        upload: { min: Infinity, max: -Infinity, avg: 0 },
        ping: { min: Infinity, max: -Infinity, avg: 0 }
      };
      let total = data.length;

      data.forEach(d => {
        stats.download.min = Math.min(stats.download.min, d.download);
        stats.download.max = Math.max(stats.download.max, d.download);
        stats.download.avg += d.download;

        stats.upload.min = Math.min(stats.upload.min, d.upload);
        stats.upload.max = Math.max(stats.upload.max, d.upload);
        stats.upload.avg += d.upload;

        stats.ping.min = Math.min(stats.ping.min, d.ping);
        stats.ping.max = Math.max(stats.ping.max, d.ping);
        stats.ping.avg += d.ping;
      });

      Object.keys(stats).forEach(key => {
        stats[key].avg = (stats[key].avg / total).toFixed(2);
        stats[key].min = stats[key].min === Infinity ? 0 : stats[key].min.toFixed(2);
        stats[key].max = stats[key].max === -Infinity ? 0 : stats[key].max.toFixed(2);
      });

      return stats;
    }

    function renderSummary(stats) {
      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = `
        <div class="stat-card">
          <h3>Download</h3>
          <p>Min: ${stats.download.min} Mbps</p>
          <p>Max: ${stats.download.max} Mbps</p>
          <p>Prom: ${stats.download.avg} Mbps</p>
        </div>
        <div class="stat-card">
          <h3>Upload</h3>
          <p>Min: ${stats.upload.min} Mbps</p>
          <p>Max: ${stats.upload.max} Mbps</p>
          <p>Prom: ${stats.upload.avg} Mbps</p>
        </div>
        <div class="stat-card">
          <h3>Ping</h3>
          <p>Min: ${stats.ping.min} ms</p>
          <p>Max: ${stats.ping.max} ms</p>
          <p>Prom: ${stats.ping.avg} ms</p>
        </div>
      `;
    }

    function renderTable(data) {
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${d.timestamp}</td>
          <td>${d.device}</td>
          <td>${d.download}</td>
          <td>${d.upload}</td>
          <td>${d.ping}</td>
        </tr>
      `).join('');
    }

    function getAvgByDevice(data) {
      const devices = [...new Set(data.map(d => d.device))];
      const avgs = { download: [], upload: [], ping: [] };

      devices.forEach(device => {
        const filtered = data.filter(d => d.device === device);
        const count = filtered.length;
        if (count === 0) return;

        avgs.download.push(filtered.reduce((sum, d) => sum + d.download, 0) / count);
        avgs.upload.push(filtered.reduce((sum, d) => sum + d.upload, 0) / count);
        avgs.ping.push(filtered.reduce((sum, d) => sum + d.ping, 0) / count);
      });

      return { devices, avgs };
    }

    function renderAvgChart(devices, avgs) {
      const datasets = [
        { label: 'Download (Mbps)', data: avgs.download, backgroundColor: 'rgba(75, 192, 192, 0.8)' },
        { label: 'Upload (Mbps)', data: avgs.upload, backgroundColor: 'rgba(255, 159, 64, 0.8)' },
        { label: 'Ping (ms)', data: avgs.ping, backgroundColor: 'rgba(153, 102, 255, 0.8)' }
      ];

      charts.avg = buildBarChart(document.getElementById('avgChart').getContext('2d'), devices, datasets);
    }

    function destroyCharts() {
      Object.values(charts).forEach(c => c.destroy());
      charts = {};
    }

    async function loadAndRender() {
      const deviceSelect = document.getElementById("deviceFilter");
      const devices = Array.from(deviceSelect.selectedOptions).map(opt => opt.value);
      const limit = document.getElementById("limitFilter").value;
      const since = document.getElementById("sinceFilter").value;
      const until = document.getElementById("untilFilter").value;

      const raw = await fetchData(limit, devices, since, until);

      currentData = raw.map(d => ({
        timestamp: d.Timestamp,
        device: d.Device,
        download: parseFloat(d.Download_Mbps),
        upload: parseFloat(d.Upload_Mbps),
        ping: parseFloat(d.Ping_ms),
      }));

      const stats = calculateStats(currentData);
      renderSummary(stats);
      renderTable(currentData);

      destroyCharts();

      charts.download = buildLineChart(
        document.getElementById('downloadChart').getContext('2d'),
        'Download (Mbps)',
        currentData.map(d => ({ timestamp: new Date(d.timestamp), value: d.download, device: d.device })),
        'rgb(75, 192, 192)',
        'rgba(75, 192, 192, 0.2)'
      );

      charts.upload = buildLineChart(
        document.getElementById('uploadChart').getContext('2d'),
        'Upload (Mbps)',
        currentData.map(d => ({ timestamp: new Date(d.timestamp), value: d.upload, device: d.device })),
        'rgb(255, 159, 64)',
        'rgba(255, 159, 64, 0.2)'
      );

      charts.ping = buildLineChart(
        document.getElementById('pingChart').getContext('2d'),
        'Ping (ms)',
        currentData.map(d => ({ timestamp: new Date(d.timestamp), value: d.ping, device: d.device })),
        'rgb(153, 102, 255)',
        'rgba(153, 102, 255, 0.2)'
      );

      const { devices: devList, avgs } = getAvgByDevice(currentData);
      if (devList.length > 1) {
        renderAvgChart(devList, avgs);
      } else {
        document.getElementById('avgChart').style.display = 'none';
      }
    }

    function exportToCSV() {
      if (currentData.length === 0) return alert('No hay datos para exportar.');

      const csv = [
        ['Timestamp', 'Device', 'Download_Mbps', 'Upload_Mbps', 'Ping_ms'],
        ...currentData.map(d => [d.timestamp, d.device, d.download, d.upload, d.ping])
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'internet_speed_data.csv';
      link.click();
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const button = document.getElementById('theme-toggle');
      button.textContent = document.body.classList.contains('dark-mode') ? '☀️ Modo Claro' : '🌙 Modo Oscuro';
    }

    function setupAutoRefresh() {
      const select = document.getElementById('autoRefresh');
      select.addEventListener('change', () => {
        if (refreshInterval) clearInterval(refreshInterval);
        const interval = parseInt(select.value);
        if (interval > 0) {
          refreshInterval = setInterval(loadAndRender, interval);
        }
      });
    }

    async function init() {
      const raw = await fetchData(50); // Cargamos 50 para rellenar filtros

      const devices = [...new Set(raw.map(d => d.Device))];
      const select = document.getElementById("deviceFilter");
      select.innerHTML = `<option value="all" selected>Todos</option>` +
        devices.map(d => `<option value="${d}">${d}</option>`).join("");

      setupAutoRefresh();
      loadAndRender();
    }

    init();
  </script>
</body>
</html>