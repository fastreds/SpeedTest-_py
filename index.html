<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä Dashboard Velocidad Internet</title>
  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ====== ESTILO BASE ====== */
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
      transition: background 0.3s, color 0.3s;
      
    }
    body.light-mode {
      background: #f9fafb;
      color: #333;
    }

    /* ====== CONTROLES ====== */
    #controls {
      background: #2c2c2c;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 1.5rem;
      
    }
    body.light-mode #controls {
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* ====== TARJETAS DE ESTAD√çSTICAS ====== */
    .stat-card {
      background: #2c2c2c;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: transform 0.2s;
       color: #f0f0f0;
    }
    body.light-mode .stat-card {
      background: #fff;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }

    /* ====== GR√ÅFICOS ====== */
    .chart-container {
      background: #2c2c2c;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: #f0f0f0;
    }
    body.light-mode .chart-container {
      background: #fff;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* ====== TABLA ====== */
    table {
      background: #2c2c2c;
      border-radius: 12px;
      overflow: hidden;
    }
    body.light-mode table {
      background: #fff;
    }
    th {
      background: #3a3a3a;
    }
    body.light-mode th {
      background: #f0f0f0;
    }

    /* ====== BOT√ìN TEMA ====== */
    #theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    /* ====== RESPONSIVO ====== */
    @media (max-width: 768px) {
      canvas {
        height: 250px !important;
      }
      .stat-card {
        padding: 0.75rem;
      }
      #controls {
        padding: 1rem;
      }
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container my-4">
    <h1 class="text-center mb-3">üìä Dashboard Velocidad Internet</h1>
    <p class="text-center">Datos en vivo desde Google Sheets (√∫ltimas 12h por defecto).</p>

    <!-- Toggle Tema -->
    <button id="theme-toggle" class="btn btn-outline-secondary" onclick="toggleTheme()">‚òÄÔ∏è Claro</button>

    <!-- Controles -->
    <div id="controls" class="mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-2">
          <label for="deviceFilter" class="form-label">Dispositivo</label>
          <select id="deviceFilter" class="form-select" multiple></select>
        </div>
        <div class="col-md-2">
          <label for="sinceFilter" class="form-label">Desde</label>
          <input type="datetime-local" id="sinceFilter" class="form-control">
        </div>
        <div class="col-md-2">
          <label for="untilFilter" class="form-label">Hasta</label>
          <input type="datetime-local" id="untilFilter" class="form-control">
        </div>
        <div class="col-md-2">
          <label for="limitFilter" class="form-label">Registros</label>
          <select id="limitFilter" class="form-select">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="autoRefresh" class="form-label">Auto-refresh</label>
          <select id="autoRefresh" class="form-select">
            <option value="0" selected>Off</option>
            <option value="30000">30s</option>
            <option value="60000">1min</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button onclick="loadAndRender()" class="btn btn-primary me-2">üîÑ Actualizar</button>
          <button onclick="exportToCSV()" class="btn btn-success">üì• CSV</button>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div id="summary" class="row mb-4"></div>

    <!-- √öltimas mediciones -->
    <div id="latest-measurements" class="text-center mb-4">
      <h2>√öltimas Mediciones</h2>
      <div class="row" id="latest-measurements-container"></div>
    </div>

    <!-- Gr√°ficos -->
    <div id="charts" class="row">
      <div class="col-12 mb-3 chart-container"><canvas id="downloadChart"></canvas></div>
      <div class="col-12 mb-3 chart-container"><canvas id="uploadChart"></canvas></div>
      <div class="col-12 mb-3 chart-container"><canvas id="pingChart"></canvas></div>
      <div class="col-12 mb-3 chart-container"><canvas id="avgChart"></canvas></div>
    </div>

    <!-- Tabla -->
    <div id="data-table" class="mt-4">
      <h2>Registros</h2>
      <div class="table-responsive">
        <table id="recordsTable" class="table table-bordered">
          <thead>
            <tr>
              <th>Timestamp</th><th>Dispositivo</th>
              <th>Download</th><th>Upload</th><th>Ping</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* URL de tu Apps Script */
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxfxPDgtvjpuAADsT1zdYZFsr5LH0OwQHp9jkkXdMT2_O2-finRgDOpPWN0aaZewbf7kQ/exec";
    let charts = {}, currentData = [], refreshInterval = null;
    const colors = [
      '#4BC0C0', // Cyan
      '#FF9F40', // Orange
      '#9966FF', // Purple
      '#FF6384', // Pink
      '#36A2EB'  // Blue
    ];

    // ====== FETCH DATOS ======
    async function fetchData(limit = 50, devices = [], since = "", until = "") {
      let url = `${SHEET_URL}?limit=${limit === 'all' ? '' : limit}`;
      if (devices.length && !devices.includes('all')) url += `&device=${devices.join(',')}`;
      if (since) url += `&since=${since}`;
      if (until) url += `&until=${until}`;
      const res = await fetch(url);
      return res.json();
    }

    // ====== HELPERS ======
    const formatDateTimeLocal = d =>
      `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    function destroyCharts(){ Object.values(charts).forEach(c=>c.destroy()); charts={}; }

    // ====== RENDER CHARTS ======
    const buildMultiLineChart = (ctx, grouped, key, colors, title) => new Chart(ctx, {
      type: 'line',
      data: {
        datasets: Object.keys(grouped).map((dev, i) => ({
          label: dev,
          data: grouped[dev].map(d => ({ x: d.timestamp, y: d[key] })),
          borderColor: colors[i % colors.length],
          backgroundColor: colors[i % colors.length] + '20', // Opacidad reducida
          borderWidth: 3, // L√≠neas m√°s gruesas
          pointRadius: 4, // Puntos m√°s visibles
          pointHoverRadius: 6,
          fill: true,
          tension: 0.4
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: title,
            font: { size: 18, weight: 'bold' },
            color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333'
          },
          legend: {
            position: 'top',
            labels: { font: { size: 12 }, color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'hour',
              displayFormats: { hour: 'MMM d, HH:mm' }
            },
            grid: { color: document.body.classList.contains('dark-mode') ? '#444' : '#ddd' },
            ticks: { color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' }
          },
          y: {
            beginAtZero: true,
            grid: { color: document.body.classList.contains('dark-mode') ? '#444' : '#ddd' },
            ticks: { color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' }
          }
        },
        hover: {
          mode: 'nearest',
          intersect: true
        }
      }
    });

    const buildBarChart = (ctx, labels, datasets) => new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Comparaci√≥n de Promedios por Dispositivo',
            font: { size: 18, weight: 'bold' },
            color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333'
          },
          legend: {
            position: 'top',
            labels: { font: { size: 12 }, color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' }
          }
        },
        scales: {
          x: { ticks: { color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' } },
          y: { beginAtZero: true, ticks: { color: document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333' } }
        }
      }
    });

    // ====== RESUMEN ======
    function calculateStats(data) {
      let stats = { download: { min: Infinity, max: -Infinity, sum: 0 }, upload: { min: Infinity, max: -Infinity, sum: 0 }, ping: { min: Infinity, max: -Infinity, sum: 0 } };
      data.forEach(d => { ['download', 'upload', 'ping'].forEach(k => {
        stats[k].min = Math.min(stats[k].min, d[k]);
        stats[k].max = Math.max(stats[k].max, d[k]);
        stats[k].sum += d[k];
      }); });
      let n = data.length;
      for (let k in stats) {
        stats[k].avg = (stats[k].sum / n || 0).toFixed(2);
        stats[k].min = isFinite(stats[k].min) ? stats[k].min.toFixed(2) : 0;
        stats[k].max = isFinite(stats[k].max) ? stats[k].max.toFixed(2) : 0;
      }
      return stats;
    }

    function renderSummaries(grouped) {
      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = '';
      Object.keys(grouped).forEach(dev => {
        const stats = calculateStats(grouped[dev]);
        const devSection = document.createElement('div');
        devSection.className = 'col-md-4 mb-3';
        devSection.innerHTML = `
          <div class="card stat-card">
            <div class="card-body">
              <h3 class="card-title">${dev}</h3>
              <div class="row">
                <div class="col-4">
                  <h4>Download</h4>
                  <p>Min: ${stats.download.min}</p>
                  <p>Max: ${stats.download.max}</p>
                  <p>Avg: ${stats.download.avg}</p>
                </div>
                <div class="col-4">
                  <h4>Upload</h4>
                  <p>Min: ${stats.upload.min}</p>
                  <p>Max: ${stats.upload.max}</p>
                  <p>Avg: ${stats.upload.avg}</p>
                </div>
                <div class="col-4">
                  <h4>Ping</h4>
                  <p>Min: ${stats.ping.min}</p>
                  <p>Max: ${stats.ping.max}</p>
                  <p>Avg: ${stats.ping.avg}</p>
                </div>
              </div>
            </div>
          </div>`;
        summaryDiv.appendChild(devSection);
      });
    }

    // ====== TABLA ======
    const renderTable = data => {
      const sortedData = [...data].sort((a, b) => b.timestamp - a.timestamp);
      document.querySelector('#recordsTable tbody').innerHTML = sortedData.map(d => `<tr>
        <td>${d.timestamp.toLocaleString()}</td><td>${d.device}</td><td>${d.download.toFixed(2)}</td><td>${d.upload.toFixed(2)}</td><td>${d.ping.toFixed(2)}</td></tr>`).join('');
    };

    // ====== RENDER √öLTIMAS MEDICIONES ======
    function renderLatestMeasurements(grouped) {
      const container = document.getElementById('latest-measurements-container');
      container.innerHTML = '';
      Object.keys(grouped).forEach(dev => {
        const devData = [...grouped[dev]].sort((a, b) => b.timestamp - a.timestamp);
        if (devData.length === 0) return;
        const latest = devData[0];
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-3';
        card.innerHTML = `
          <div class="card stat-card">
            <div class="card-body">
              <h3 class="card-title">Dispositivo: ${dev}</h3>
              <p>Download: ${latest.download.toFixed(2)} Mbps</p>
              <p>Upload: ${latest.upload.toFixed(2)} Mbps</p>
              <p>Ping: ${latest.ping.toFixed(2)} ms</p>
              <p>Timestamp: ${latest.timestamp.toLocaleString()}</p>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    // ====== CARGAR Y RENDERIZAR ======
    async function loadAndRender() {
      const devices = [...document.getElementById("deviceFilter").selectedOptions].map(o => o.value);
      const limit = document.getElementById("limitFilter").value;
      const since = document.getElementById("sinceFilter").value;
      const until = document.getElementById("untilFilter").value;

      const raw = await fetchData(limit, devices, since, until);
      currentData = raw.map(d => ({ timestamp: new Date(d.Timestamp), device: d.Device, download: +d.Download_Mbps, upload: +d.Upload_Mbps, ping: +d.Ping_ms }));

      const grouped = currentData.reduce((acc, d) => {
        if (!acc[d.device]) acc[d.device] = [];
        acc[d.device].push(d);
        return acc;
      }, {});

      renderSummaries(grouped);
      renderTable(currentData);
      renderLatestMeasurements(grouped);

      destroyCharts();
      charts.download = buildMultiLineChart(downloadChart.getContext('2d'), grouped, 'download', colors, 'Velocidad de Descarga (Mbps)');
      charts.upload = buildMultiLineChart(uploadChart.getContext('2d'), grouped, 'upload', colors, 'Velocidad de Subida (Mbps)');
      charts.ping = buildMultiLineChart(pingChart.getContext('2d'), grouped, 'ping', colors, 'Ping (ms)');

      const devicesSet = Object.keys(grouped);
      if (devicesSet.length > 1) {
        const avgs = { download: [], upload: [], ping: [] };
        devicesSet.forEach(dev => {
          let f = grouped[dev], n = f.length;
          avgs.download.push(f.reduce((s, d) => s + d.download, 0) / n);
          avgs.upload.push(f.reduce((s, d) => s + d.upload, 0) / n);
          avgs.ping.push(f.reduce((s, d) => s + d.ping, 0) / n);
        });
        charts.avg = buildBarChart(avgChart.getContext('2d'), devicesSet, [
          { label: 'Download', data: avgs.download, backgroundColor: 'rgba(75,192,192,0.8)' },
          { label: 'Upload', data: avgs.upload, backgroundColor: 'rgba(255,159,64,0.8)' },
          { label: 'Ping', data: avgs.ping, backgroundColor: 'rgba(153,102,255,0.8)' }
        ]);
        avgChart.style.display = 'block';
      } else {
        avgChart.style.display = 'none';
      }
    }

    // ====== EXPORT CSV ======
    function exportToCSV() {
      if (!currentData.length) return alert('No hay datos');
      const csv = [['Timestamp', 'Device', 'Download', 'Upload', 'Ping'], ...currentData.map(d => [d.timestamp, d.device, d.download, d.upload, d.ping])].map(r => r.join(',')).join('\n');
      const link = document.createElement('a');
      link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      link.download = 'internet_speed.csv';
      link.click();
    }

    // ====== TEMA ======
    function toggleTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      document.body.classList.toggle('dark-mode');
      document.body.classList.toggle('light-mode');
      themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Claro' : 'üåô Oscuro';
      themeToggle.classList.toggle('btn-outline-secondary');
      themeToggle.classList.toggle('btn-outline-dark');
      // Actualizar colores de los gr√°ficos al cambiar el tema
      Object.values(charts).forEach(chart => {
        chart.options.plugins.title.color = document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333';
        chart.options.plugins.legend.labels.color = document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333';
        chart.options.scales.x.grid.color = document.body.classList.contains('dark-mode') ? '#444' : '#ddd';
        chart.options.scales.y.grid.color = document.body.classList.contains('dark-mode') ? '#444' : '#ddd';
        chart.options.scales.x.ticks.color = document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333';
        chart.options.scales.y.ticks.color = document.body.classList.contains('dark-mode') ? '#f0f0f0' : '#333';
        chart.update();
      });
    }

    // ====== AUTO REFRESH ======
    function setupAutoRefresh() {
      autoRefresh.addEventListener('change', () => {
        if (refreshInterval) clearInterval(refreshInterval);
        let ms = +autoRefresh.value;
        if (ms > 0) refreshInterval = setInterval(loadAndRender, ms);
      });
    }

    // ====== INIT ======
    async function init() {
      let now = new Date(), past = new Date(now.getTime() - 12 * 60 * 60 * 1000);
      sinceFilter.value = formatDateTimeLocal(past);
      untilFilter.value = formatDateTimeLocal(now);

      const raw = await fetchData(50);
      const devices = [...new Set(raw.map(d => d.Device))];
      deviceFilter.innerHTML = '<option value="all" selected>Todos</option>' + devices.map(d => `<option value="${d}">${d}</option>`).join('');
      setupAutoRefresh();
      loadAndRender();
    }
    init();
  </script>
</body>
</html>