<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä Dashboard Velocidad Internet</title>
  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    /* ====== ESTILO BASE ====== */
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      background: #1e1e1e;
      color: #f0f0f0;
      font-size: 16px;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: #f9fafb;
      color: #333;
    }

    h1 { text-align: center; font-size: 1.5rem; }

    /* ====== CONTROLES ====== */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      padding: 1rem;
      margin: 1rem auto;
      background: #2c2c2c;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-width: 95vw;
    }
    body.light-mode #controls { background: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    select, input, button {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #555;
      font-size: 0.9rem;
      width: 100%;
      max-width: 180px;
      box-sizing: border-box;
    }
    body.light-mode select, body.light-mode input, body.light-mode button {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
    }
    button:hover { background: #4a4a4a; cursor: pointer; }
    body.light-mode button:hover { background: #e0e0e0; }

    /* ====== TARJETAS DE ESTAD√çSTICAS ====== */
    #summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .stat-card {
      background: #2c2c2c;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    body.light-mode .stat-card { background: #fff; }

    /* ====== GR√ÅFICOS ====== */
    #charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    canvas {
      background: #2c2c2c;
      border-radius: 12px;
      padding: 0.5rem;
      width: 100% !important;
      height: 250px !important; /* altura fija para m√≥viles */
    }
    body.light-mode canvas { background: #fff; }

    /* ====== TABLA ====== */
    #data-table { margin-top: 2rem; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #2c2c2c;
      border-radius: 12px;
      overflow: hidden;
    }
    body.light-mode table { background: #fff; }
    th, td {
      padding: 0.6rem;
      font-size: 0.8rem;
      border-bottom: 1px solid #444;
    }
    body.light-mode th, body.light-mode td { border-bottom: 1px solid #ddd; }
    th { background: #3a3a3a; }
    body.light-mode th { background: #f0f0f0; }

    /* ====== BOT√ìN TEMA ====== */
    #theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ====== RESPONSIVO ====== */
    @media (max-width: 600px) {
      h1 { font-size: 1.2rem; }
      #controls { flex-direction: column; }
      select, input, button { max-width: 100%; }
      th, td { font-size: 0.7rem; }
    }
  </style>
</head>
<body class="dark-mode">
  <h1>üìä Dashboard Velocidad Internet</h1>
  <p style="text-align:center">Datos en vivo desde Google Sheets (√∫ltimas 12h por defecto).</p>

  <!-- Toggle Tema -->
  <button id="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è Claro</button>

  <!-- Controles -->
  <div id="controls">
    <label>Dispositivo: <select id="deviceFilter" multiple></select></label>
    <label>Desde: <input type="datetime-local" id="sinceFilter"></label>
    <label>Hasta: <input type="datetime-local" id="untilFilter"></label>
    <label>Registros:
      <select id="limitFilter">
        <option value="10">10</option>
        <option value="20" >20</option>
        <option value="50" selected >50</option>
        <option value="100">100</option>
        <option value="all">Todos</option>
      </select>
    </label>
    <label>Auto-refresh:
      <select id="autoRefresh">
        <option value="0" selected>Off</option>
        <option value="30000">30s</option>
        <option value="60000">1min</option>
      </select>
    </label>
    <button onclick="loadAndRender()">üîÑ Actualizar</button>
    <button onclick="exportToCSV()">üì• CSV</button>
  </div>

  <!-- Resumen -->
  <div id="summary"></div>

  <!-- √öltima medici√≥n -->
  <div id="latest-measurement" style="text-align: center; margin-top: 1rem;">
    <h2>√öltima Medici√≥n</h2>
    <div class="stat-card">
      <h3>Dispositivo: <span id="latest-device">-</span></h3>
      <p>Download: <span id="latest-download">-</span> Mbps</p>
      <p>Upload: <span id="latest-upload">-</span> Mbps</p>
      <p>Ping: <span id="latest-ping">-</span> ms</p>
      <p>Timestamp: <span id="latest-timestamp">-</span></p>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div id="charts">
    <canvas id="downloadChart"></canvas>
    <canvas id="uploadChart"></canvas>
    <canvas id="pingChart"></canvas>
    <canvas id="avgChart"></canvas>
  </div>

  <!-- Tabla -->
  <div id="data-table">
    <h2>Registros</h2>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Timestamp</th><th>Dispositivo</th>
          <th>Download</th><th>Upload</th><th>Ping</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    /* URL de tu Apps Script */
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxfxPDgtvjpuAADsT1zdYZFsr5LH0OwQHp9jkkXdMT2_O2-finRgDOpPWN0aaZewbf7kQ/exec";
    let charts = {}, currentData = [], refreshInterval = null;

    // ====== FETCH DATOS ======
    async function fetchData(limit = 50, devices = [], since = "", until = "") {
      let url = `${SHEET_URL}?limit=${limit === 'all' ? '' : limit}`;
      if (devices.length && !devices.includes('all')) url += `&device=${devices.join(',')}`;
      if (since) url += `&since=${since}`;
      if (until) url += `&until=${until}`;
      const res = await fetch(url);
      return res.json();
    }

    // ====== HELPERS ======
    const formatDateTimeLocal = d =>
      `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    function destroyCharts(){ Object.values(charts).forEach(c=>c.destroy()); charts={}; }

    // ====== RENDER CHARTS ======
    const buildLineChart = (ctx, label, data, color) => new Chart(ctx,{
      type:'line',
      data:{ labels:data.map(d=>d.timestamp), datasets:[{ label, data:data.map(d=>d.value), borderColor:color, backgroundColor:color+'33', fill:true, tension:0.3 }]},
      options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, scales:{ x:{type:'time',time:{unit:'hour'}}, y:{beginAtZero:true} } }
    });

    const buildBarChart = (ctx,labels,datasets)=> new Chart(ctx,{type:'bar',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false}});

    // ====== RESUMEN ======
    function calculateStats(data){
      let stats={download:{min:Infinity,max:-Infinity,sum:0}, upload:{min:Infinity,max:-Infinity,sum:0}, ping:{min:Infinity,max:-Infinity,sum:0}};
      data.forEach(d=>{ ['download','upload','ping'].forEach(k=>{
        stats[k].min=Math.min(stats[k].min,d[k]);
        stats[k].max=Math.max(stats[k].max,d[k]);
        stats[k].sum+=d[k];
      })});
      let n=data.length;
      for(let k in stats){ stats[k].avg=(stats[k].sum/n||0).toFixed(2); stats[k].min=isFinite(stats[k].min)?stats[k].min.toFixed(2):0; stats[k].max=isFinite(stats[k].max)?stats[k].max.toFixed(2):0; }
      return stats;
    }
    function renderSummary(s){
      document.getElementById('summary').innerHTML=`
        <div class="stat-card"><h3>Download</h3><p>Min:${s.download.min}</p><p>Max:${s.download.max}</p><p>Avg:${s.download.avg}</p></div>
        <div class="stat-card"><h3>Upload</h3><p>Min:${s.upload.min}</p><p>Max:${s.upload.max}</p><p>Avg:${s.upload.avg}</p></div>
        <div class="stat-card"><h3>Ping</h3><p>Min:${s.ping.min}</p><p>Max:${s.ping.max}</p><p>Avg:${s.ping.avg}</p></div>`;
    }

    // ====== TABLA ======
    const renderTable=data=>{
      document.querySelector('#recordsTable tbody').innerHTML=data.map(d=>`<tr>
        <td>${d.timestamp}</td><td>${d.device}</td><td>${d.download}</td><td>${d.upload}</td><td>${d.ping}</td></tr>`).join('');
    };

    // ====== RENDER √öLTIMA MEDICI√ìN ======
    function renderLatestMeasurement(data) {
      if (!data.length) {
        document.getElementById('latest-measurement').style.display = 'none';
        return;
      }
      const latest = data[data.length - 1];
      document.getElementById('latest-device').textContent = latest.device;
      document.getElementById('latest-download').textContent = latest.download.toFixed(2);
      document.getElementById('latest-upload').textContent = latest.upload.toFixed(2);
      document.getElementById('latest-ping').textContent = latest.ping.toFixed(2);
      document.getElementById('latest-timestamp').textContent = latest.timestamp.toLocaleString();
      document.getElementById('latest-measurement').style.display = 'block';
    }

    // ====== CARGAR Y RENDERIZAR ======
    async function loadAndRender(){
      const devices=[...document.getElementById("deviceFilter").selectedOptions].map(o=>o.value);
      const limit=document.getElementById("limitFilter").value;
      const since=document.getElementById("sinceFilter").value;
      const until=document.getElementById("untilFilter").value;

      const raw=await fetchData(limit,devices,since,until);
      currentData=raw.map(d=>({ timestamp:new Date(d.Timestamp), device:d.Device, download:+d.Download_Mbps, upload:+d.Upload_Mbps, ping:+d.Ping_ms }));

      renderSummary(calculateStats(currentData));
      renderTable(currentData);
      renderLatestMeasurement(currentData);

      destroyCharts();
      charts.download=buildLineChart(downloadChart.getContext('2d'),'Download',currentData.map(d=>({timestamp:d.timestamp,value:d.download})), 'rgb(75,192,192)');
      charts.upload=buildLineChart(uploadChart.getContext('2d'),'Upload',currentData.map(d=>({timestamp:d.timestamp,value:d.upload})), 'rgb(255,159,64)');
      charts.ping=buildLineChart(pingChart.getContext('2d'),'Ping',currentData.map(d=>({timestamp:d.timestamp,value:d.ping})), 'rgb(153,102,255)');

      // Gr√°fico comparativo por dispositivo
      const devicesSet=[...new Set(currentData.map(d=>d.device))];
      if(devicesSet.length>1){
        const avgs={download:[],upload:[],ping:[]};
        devicesSet.forEach(dev=>{
          let f=currentData.filter(d=>d.device===dev),n=f.length;
          avgs.download.push(f.reduce((s,d)=>s+d.download,0)/n);
          avgs.upload.push(f.reduce((s,d)=>s+d.upload,0)/n);
          avgs.ping.push(f.reduce((s,d)=>s+d.ping,0)/n);
        });
        charts.avg=buildBarChart(avgChart.getContext('2d'),devicesSet,[
          {label:'Download',data:avgs.download,backgroundColor:'rgba(75,192,192,0.8)'},
          {label:'Upload',data:avgs.upload,backgroundColor:'rgba(255,159,64,0.8)'},
          {label:'Ping',data:avgs.ping,backgroundColor:'rgba(153,102,255,0.8)'}
        ]);
        avgChart.style.display='block';
      } else avgChart.style.display='none';
    }

    // ====== EXPORT CSV ======
    function exportToCSV(){
      if(!currentData.length) return alert('No hay datos');
      const csv=[['Timestamp','Device','Download','Upload','Ping'],...currentData.map(d=>[d.timestamp,d.device,d.download,d.upload,d.ping])].map(r=>r.join(',')).join('\n');
      const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); link.download='internet_speed.csv'; link.click();
    }

    // ====== TEMA ======
    function toggleTheme(){
      document.body.classList.toggle('dark-mode'); document.body.classList.toggle('light-mode');
      themeToggle.textContent=document.body.classList.contains('dark-mode')?'‚òÄÔ∏è Claro':'üåô Oscuro';
    }

    // ====== AUTO REFRESH ======
    function setupAutoRefresh(){
      autoRefresh.addEventListener('change',()=>{
        if(refreshInterval) clearInterval(refreshInterval);
        let ms=+autoRefresh.value; if(ms>0) refreshInterval=setInterval(loadAndRender,ms);
      });
    }

    // ====== INIT ======
    async function init(){
      let now=new Date(), past=new Date(now.getTime()-12*60*60*1000);
      sinceFilter.value=formatDateTimeLocal(past);
      untilFilter.value=formatDateTimeLocal(now);

      const raw=await fetchData(50);
      const devices=[...new Set(raw.map(d=>d.Device))];
      deviceFilter.innerHTML='<option value="all" selected>Todos</option>'+devices.map(d=>`<option value="${d}">${d}</option>`).join('');
      setupAutoRefresh();
      loadAndRender();
    }
    init();
  </script>
</body>
</html>
